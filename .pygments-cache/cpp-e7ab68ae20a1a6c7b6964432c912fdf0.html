<div class="highlight"><pre><span class="kt">char</span><span class="o">*</span> <span class="nf">Jstring2CStr</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">jstr</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="kt">char</span><span class="o">*</span> <span class="n">rtn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	 <span class="n">jclass</span> <span class="n">clsstring</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="s">&quot;java/lang/String&quot;</span><span class="p">);</span>
	 <span class="n">jstring</span> <span class="n">strencode</span> <span class="o">=</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="s">&quot;GB2312&quot;</span><span class="p">);</span>
	 <span class="n">jmethodID</span> <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">clsstring</span><span class="p">,</span> <span class="s">&quot;getBytes&quot;</span><span class="p">,</span> <span class="s">&quot;(Ljava/lang/String;)[B&quot;</span><span class="p">);</span>
	 <span class="n">jbyteArray</span> <span class="n">barr</span><span class="o">=</span> <span class="p">(</span><span class="n">jbyteArray</span><span class="p">)(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">jstr</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">strencode</span><span class="p">);</span> <span class="c1">// String .getByte(&quot;GB2312&quot;);</span>
	 <span class="n">jsize</span> <span class="n">alen</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">barr</span><span class="p">);</span>
	 <span class="n">jbyte</span><span class="o">*</span> <span class="n">ba</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetByteArrayElements</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">barr</span><span class="p">,</span><span class="n">JNI_FALSE</span><span class="p">);</span>
	 <span class="k">if</span><span class="p">(</span><span class="n">alen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	 <span class="p">{</span>
	  <span class="n">rtn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">alen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//&quot;\0&quot;</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span><span class="n">ba</span><span class="p">,</span><span class="n">alen</span><span class="p">);</span>
	  <span class="n">rtn</span><span class="p">[</span><span class="n">alen</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	 <span class="p">}</span>
	 <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ReleaseByteArrayElements</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">barr</span><span class="p">,</span><span class="n">ba</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	 <span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>